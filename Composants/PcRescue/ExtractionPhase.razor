@using NuitInfo.Rubeus.PcRescue.Models
@using NuitInfo.Rubeus.PcRescue.Services
@inject PcRescueGameService Game

<div class="extraction-phase">
    <!-- HUD -->
    <div class="hud">
        <div class="hud-item">
            <span class="hud-label">üí∞ Budget:</span>
            <span class="hud-value">@Game.State.Budget ‚Ç¨</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">üå± √âco-Score:</span>
            <span class="hud-value">@Game.State.EcoScore</span>
        </div>
    </div>

    <h1 class="phase-title">Phase 2 - Extraction & Tri</h1>

    <!-- Zone principale d'extraction et tri -->
    <div class="main-content">
        <!-- Zone du PC avec composants √† extraire -->
        @if (GetComponentsToExtract().Any() || GetComponentsToSort().Any())
        {
            <div class="pc-zone">
                <div class="pc-interior">
                    <img src="/pc-rescue-game/pc_vue3.png" alt="Int√©rieur du PC" class="pc-background"/>

                    <!-- Composants √† extraire -->
                    @foreach (var component in GetComponentsToExtract())
                    {
                        <div class="component-clickable"
                             style="@GetComponentPosition(component)"
                             @onclick="() => StartQte(component)">
                            <img src="@component.ImagePath" alt="@component.Id" class="component-image"/>
                            <div class="component-pulse"></div>
                        </div>
                    }
                </div>

                <!-- Message d'instruction -->
                @if (GetComponentsToExtract().Any())
                {
                    <p class="instruction-text">
                        ‚ö° Cliquez sur un composant pour l'extraire !
                    </p>
                }
            </div>

            <!-- Composants extraits en attente de tri -->
            @if (GetComponentsToSort().Any())
            {
                <div class="components-to-sort">
                    <h3 class="sort-title">Composants √† trier:</h3>
                    <div class="draggable-components">
                        @foreach (var component in GetComponentsToSort())
                        {
                            <div class="draggable-component"
                                 draggable="true"
                                 @ondragstart="() => HandleDragStart(component)"
                                 @ondragend="HandleDragEnd">
                                <img src="@component.ImagePath" alt="@component.Id"/>
                                <div class="component-info">
                                    <span class="component-name">@GetComponentName(component)</span>
                                    <span class="component-condition @GetConditionClass(component.Condition)">
                                        @GetConditionText(component.Condition)
                                    </span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Bacs de tri -->
                <div class="bins-zone">
                    <h3 class="bins-title">Triez dans le bon bac:</h3>
                    <div class="bins-container">
                        <!-- Bac Poubelle -->
                        <div class="bin trash @(IsDragOver("trash") ? "drag-over" : "")"
                             @ondragover="HandleDragOver"
                             @ondragover:preventDefault="true"
                             @ondragleave="HandleDragLeave"
                             @ondrop="@(() => HandleDrop("trash"))"
                             @ondrop:preventDefault="true">
                            <div class="bin-icon">üóëÔ∏è</div>
                            <div class="bin-label">Poubelle</div>
                            <div class="bin-description">D√©chets non recyclables</div>
                            <div class="bin-stats">
                                <span class="stat-eco negative">-5 √©co</span>
                                <span class="stat-money">0 ‚Ç¨</span>
                            </div>
                        </div>

                        <!-- Bac Recyclage -->
                        <div class="bin recycle @(IsDragOver("recycle") ? "drag-over" : "")"
                             @ondragover="HandleDragOver"
                             @ondragover:preventDefault="true"
                             @ondragleave="HandleDragLeave"
                             @ondrop="@(() => HandleDrop("recycle"))"
                             @ondrop:preventDefault="true">
                            <div class="bin-icon">‚ôªÔ∏è</div>
                            <div class="bin-label">Recyclage</div>
                            <div class="bin-description">Mat√©riaux recyclables</div>
                            <div class="bin-stats">
                                <span class="stat-eco positive">+10-15 √©co</span>
                                <span class="stat-money">+Valeur/4</span>
                            </div>
                        </div>

                        <!-- Bac R√©emploi -->
                        <div class="bin reuse @(IsDragOver("reuse") ? "drag-over" : "")"
                             @ondragover="HandleDragOver"
                             @ondragover:preventDefault="true"
                             @ondragleave="HandleDragLeave"
                             @ondrop="@(() => HandleDrop("reuse"))"
                             @ondrop:preventDefault="true">
                            <div class="bin-icon">üîÑ</div>
                            <div class="bin-label">R√©emploi</div>
                            <div class="bin-description">Donner une seconde vie</div>
                            <div class="bin-stats">
                                <span class="stat-eco positive">+15-25 √©co</span>
                                <span class="stat-money">+Valeur/2</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <!-- Tous les composants sont tri√©s -->
            <div class="completion-message">
                <div class="success-icon">‚úÖ</div>
                <h2>Extraction et tri termin√©s !</h2>
                <p>Vous avez trait√© tous les composants avec succ√®s.</p>
                <button class="btn-continue" @onclick="GoToShop">
                    Continuer vers le Shop ‚Üí
                </button>
            </div>
        }
    </div>

    <!-- Overlay QTE -->
    @if (_showQte && _currentQteComponent != null)
    {
        <QteOverlay OnFinished="HandleQteFinished"/>
    }
</div>

@code {
    // Param√®tre callback pour notifier le parent d'un changement de phase
    [Parameter]
    public EventCallback OnPhaseChanged { get; set; }

    // Composant actuellement en QTE
    private PcComponent? _currentQteComponent = null;

    // Affichage de l'overlay QTE
    private bool _showQte = false;

    // Composant en cours de drag
    private PcComponent? _draggedComponent = null;

    // Bac actuellement survol√©
    private string? _currentDragOverBin = null;

    /// <summary>
    /// R√©cup√®re les composants √† extraire (√©tat InstalledOld)
    /// </summary>
    private IEnumerable<PcComponent> GetComponentsToExtract()
    {
        return Game.State.Components.Where(c => c.State == ComponentState.InstalledOld);
    }

    /// <summary>
    /// R√©cup√®re les composants √† trier (√©tat Removed)
    /// </summary>
    private IEnumerable<PcComponent> GetComponentsToSort()
    {
        return Game.State.Components.Where(c => c.State == ComponentState.Removed);
    }

    /// <summary>
    /// D√©marre le QTE pour un composant
    /// </summary>
    private void StartQte(PcComponent component)
    {
        _currentQteComponent = component;
        _showQte = true;
    }

    /// <summary>
    /// G√®re la fin du QTE
    /// </summary>
    private void HandleQteFinished(QteResult result)
    {
        if (_currentQteComponent != null)
        {
            Game.ApplyQteExtraction(_currentQteComponent, result);
            _currentQteComponent = null;
        }

        _showQte = false;
    }

    /// <summary>
    /// G√®re le d√©but du drag
    /// </summary>
    private void HandleDragStart(PcComponent component)
    {
        _draggedComponent = component;
    }

    /// <summary>
    /// G√®re la fin du drag
    /// </summary>
    private void HandleDragEnd()
    {
        _draggedComponent = null;
        _currentDragOverBin = null;
    }

    /// <summary>
    /// G√®re le survol d'un bac
    /// </summary>
    private void HandleDragOver()
    {
        // N√©cessaire pour permettre le drop
    }

    /// <summary>
    /// G√®re le survol d'un bac sp√©cifique
    /// </summary>
    private void HandleDragLeave()
    {
        _currentDragOverBin = null;
    }

    /// <summary>
    /// G√®re le drop dans un bac
    /// </summary>
    private void HandleDrop(string binType)
    {
        if (_draggedComponent != null)
        {
            Game.ApplySorting(_draggedComponent, binType);
            _draggedComponent = null;
            _currentDragOverBin = null;
        }
    }

    /// <summary>
    /// V√©rifie si un bac est actuellement survol√©
    /// </summary>
    private bool IsDragOver(string binType)
    {
        return _currentDragOverBin == binType;
    }

    /// <summary>
    /// Retourne la position d'un composant dans le PC
    /// (Vous pouvez ajuster ces positions selon vos besoins)
    /// </summary>
    private string GetComponentPosition(PcComponent component)
    {
        return component.Slot switch
        {
            ComponentSlot.Gpu => "top: 65%; left: 43%;",        // GPU : milieu bas
            ComponentSlot.Ram => "top: 20%; left: 70%;",        // RAM : haut √† droite
            ComponentSlot.Storage => "top: 82%; left: 30%;",    // Storage : bas √† gauche
            ComponentSlot.Cpu => "top: 45%; left: 40%;",        // CPU : milieu haut
            ComponentSlot.Psu => "top: 82%; left: 70%;",        // PSU : bas √† droite
            _ => "top: 50%; left: 50%;"
        };
    }

    /// <summary>
    /// Retourne le nom d'un composant
    /// </summary>
    private string GetComponentName(PcComponent component)
    {
        return component.Slot switch
        {
            ComponentSlot.Gpu => "Carte Graphique",
            ComponentSlot.Ram => "M√©moire RAM",
            ComponentSlot.Storage => "Stockage",
            ComponentSlot.Cpu => "Processeur",
            ComponentSlot.Psu => "Alimentation",
            _ => "Composant"
        };
    }

    /// <summary>
    /// Retourne le texte de condition
    /// </summary>
    private string GetConditionText(ComponentCondition condition)
    {
        return condition switch
        {
            ComponentCondition.Intact => "Intact",
            ComponentCondition.Damaged => "Endommag√©",
            ComponentCondition.Broken => "Cass√©",
            _ => "Inconnu"
        };
    }

    /// <summary>
    /// Retourne la classe CSS de condition
    /// </summary>
    private string GetConditionClass(ComponentCondition condition)
    {
        return condition switch
        {
            ComponentCondition.Intact => "condition-intact",
            ComponentCondition.Damaged => "condition-damaged",
            ComponentCondition.Broken => "condition-broken",
            _ => ""
        };
    }

    /// <summary>
    /// Passe √† la phase Shop
    /// </summary>
    private async Task GoToShop()
    {
        Game.State.Phase = GamePhase.Shop;
        // Notifie le composant parent d'invoquer StateHasChanged()
        await OnPhaseChanged.InvokeAsync();
    }
}
