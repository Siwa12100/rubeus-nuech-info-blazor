@rendermode InteractiveServer
@using System.Net.Http.Json
@using NuitInfo.Rubeus.GastonBergeur.Dtos
@using Microsoft.AspNetCore.Components
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="chat-widget">
    @if (!IsOpen)
    {
        <!-- Bulle flottante -->
        <button class="chat-bubble" @onclick="OpenChat" title="Ouvrir le chat">
            <img src="/GastonBergeurImg/GastonBergeur.png" alt="Chat" />
        </button>
    }
    else
    {
        <!-- Pop-up de chat -->
        <div class="chat-popup">
            <!-- Header -->
            <div class="chat-header">
                <span>Gaston-Bergeur le gambergeur</span>
                <button class="chat-close" @onclick="CloseChat" title="Fermer">✕</button>
            </div>

            <!-- Messages -->
            <div class="chat-messages" @ref="messagesContainer">
                @foreach (var msg in Messages)
                {
                    <div class="message @(msg.IsUser ? "user" : "assistant")">
                        @if (!msg.IsUser)
                        {
                            <img src="/GastonBergeurImg/GastonBergeurAuBar.png" alt="Gaston" class="profile-pic" />
                        }
                        <div class="message-bubble">
                            <div class="message-content">@msg.Content</div>
                            <div class="message-time">@msg.Timestamp.ToString("HH:mm")</div>
                        </div>
                    </div>
                }

                @if (IsSending)
                {
                    <div class="message assistant typing">
                        <img src="/GastonBergeurImg/GastonBergeurParle.gif" alt="Gaston parle" class="profile-pic" />
                        <div class="message-bubble">
                            <div class="message-content">
                                <span class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Input -->
            <div class="chat-input">
                <input
                    type="text"
                    placeholder="Tapez votre message..."
                    @bind="CurrentInput"
                    @bind:event="oninput"
                    @onkeydown="HandleKeyDown"
                    disabled="@IsSending"
                />
                <button
                    @onclick="SendMessage"
                    disabled="@(string.IsNullOrWhiteSpace(CurrentInput) || IsSending)"
                    title="Envoyer">
                    ➤
                </button>
            </div>
        </div>
    }
</div>

@code {
    private ElementReference messagesContainer;

    // État du widget
    private bool IsOpen { get; set; } = false;
    private bool IsSending { get; set; } = false;
    private string? CurrentInput { get; set; }
    private List<ChatMessageDto> Messages { get; set; } = new();
    private string SessionId { get; set; } = Guid.NewGuid().ToString();

    private void OpenChat()
    {
        IsOpen = true;
    }

    private void CloseChat()
    {
        IsOpen = false;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(CurrentInput) && !IsSending)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(CurrentInput) || IsSending)
            return;

        var userMessage = CurrentInput.Trim();
        CurrentInput = string.Empty;

        // Ajouter le message de l'utilisateur
        Messages.Add(new ChatMessageDto
        {
            IsUser = true,
            Content = userMessage,
            Timestamp = DateTimeOffset.UtcNow
        });

        IsSending = true;
        StateHasChanged();
        await ScrollToBottom();

        try
        {
            // Appeler l'API backend
            var request = new ChatRequestDto
            {
                SessionId = SessionId,
                Message = userMessage
            };

            // Construire l'URI absolue
            var apiUrl = Navigation.ToAbsoluteUri("/api/chat").ToString();
            var response = await Http.PostAsJsonAsync(apiUrl, request);
            response.EnsureSuccessStatusCode();

            var chatResponse = await response.Content.ReadFromJsonAsync<ChatResponseDto>();

            if (chatResponse?.Messages != null)
            {
                // Ajouter les messages de la réponse
                foreach (var msg in chatResponse.Messages)
                {
                    Messages.Add(msg);
                }
                StateHasChanged();
                await ScrollToBottom();
            }
        }
        catch (Exception ex)
        {
            // Afficher une erreur dans le chat
            Messages.Add(new ChatMessageDto
            {
                IsUser = false,
                Content = $"❌ Erreur : {ex.Message}",
                Timestamp = DateTimeOffset.UtcNow
            });
        }
        finally
        {
            IsSending = false;
            StateHasChanged();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            // Attendre que le DOM soit mis à jour
            await Task.Delay(10);
            await JSRuntime.InvokeVoidAsync("eval",
                @"setTimeout(() => {
                    const messages = document.querySelector('.chat-messages');
                    if (messages) {
                        messages.scrollTop = messages.scrollHeight;
                    }
                }, 0);");
        }
        catch
        {
            // Ignore si l'élément n'existe pas encore
        }
    }
}
