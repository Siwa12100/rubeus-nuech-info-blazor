@page "/snake"
@rendermode InteractiveServer
@using NuitInfo.Rubeus.Modeles.SnakeGame
@using NuitInfo.Rubeus.Repositories
@inject IJSRuntime JS
@inject ISnakeGameEngine GameEngine
@implements IAsyncDisposable

<PageTitle>Snake Game</PageTitle>

<div class="snake-container" @ref="containerRef">
    <div class="snake-header">
        <h1>üêç Snake Game</h1>
        <div class="game-info">
            <div class="info-item">
                <span class="label">Score:</span>
                <span class="value">@gameState?.Score</span>
            </div>
            <div class="info-item">
                <span class="label">Longueur:</span>
                <span class="value">@gameState?.Length</span>
            </div>
            <div class="info-item">
                <span class="label">Temps:</span>
                <span class="value">@FormatTime(gameState?.ElapsedMs ?? 0)</span>
            </div>
            <div class="info-item">
                <span class="label">Difficult√©:</span>
                <span class="value">@gameState?.Difficulty</span>
            </div>
        </div>
    </div>

    <div class="game-controls">
        <button class="btn btn-primary" @onclick="StartGame" disabled="@(gameState?.Status != GameStatus.NotStarted)">
            D√©marrer (ou Entr√©e)
        </button>
        <button class="btn btn-warning" @onclick="PauseResumeGame" disabled="@(gameState?.Status != GameStatus.Playing && gameState?.Status != GameStatus.Paused)">
            @(gameState?.Status == GameStatus.Playing ? "Pause" : "Reprendre")
        </button>
        <button class="btn btn-danger" @onclick="ResetGame">
            R√©initialiser
        </button>

        <div class="difficulty-selector">
            <label>Difficult√©:</label>
            <select class="form-control" @onchange="ChangeDifficulty" disabled="@(gameState?.Status != GameStatus.NotStarted)">
                <option value="Easy">Facile</option>
                <option value="Medium" selected>Moyen</option>
                <option value="Hard">Difficile</option>
                <option value="Insane">Impossible</option>
            </select>
        </div>
    </div>

    <div class="game-board-container" @ref="gameboardRef">
        @if (gameState != null)
        {
            var viewBoxValue = $"0 0 {gameState.GridWidth} {gameState.GridHeight}";
            <div class="game-board-wrapper">
                <svg class="game-canvas" viewBox="@viewBoxValue">
                    <!-- Grille de fond - image tile with subtle prison bars -->
                    <defs>
                        <pattern id="grid" x="0" y="0" width="4" height="4" patternUnits="userSpaceOnUse">
                            <image href="/images/Prison.png" x="0" y="0" width="4" height="4" preserveAspectRatio="none" />
                        </pattern>
                    </defs>
                    <rect width="@gameState.GridWidth" height="@gameState.GridHeight" fill="#151515" stroke="#000" stroke-width="0.1"/>
                    <rect width="@gameState.GridWidth" height="@gameState.GridHeight" fill="url(#grid)"/>

                    <!-- Nourriture sp√©ciale -->
                    @if (gameState.SpecialFood != null)
                    {
                        <circle cx="@(gameState.SpecialFood.X + 0.5)" cy="@(gameState.SpecialFood.Y + 0.5)" r="0.35" fill="#FFD700" class="special-food"/>
                    }

                    <!-- Nourriture normale (image - book) -->
                    @if (gameState.Food != null)
                    {
                        <image x="@(gameState.Food.X - 0.3)" y="@(gameState.Food.Y - 0.3)" width="1.6" height="1.6" href="/images/1.png" preserveAspectRatio="xMidYMid meet" class="food" />
                    }

                    <!-- Corps du serpent (render body segments first so head appears above) -->
                    @if (gameState.SnakeBody.Count > 0)
                    {
                        @for (int i = 1; i < gameState.SnakeBody.Count; i++)
                        {
                            var segment = gameState.SnakeBody[i];
                            var opacityValue = 1 - i * 0.02;
                            <rect x="@segment.X" y="@segment.Y" width="1" height="1" fill="#4CAF50" opacity="@opacityValue" rx="0.05"/>
                        }
                    }

                    <!-- Head rendered last so it appears above body and food -->
                    @if (gameState.SnakeBody.Count > 0)
                    {
                        var head = gameState.SnakeBody[0];
                        var angle = gameState.CurrentDirection switch
                        {
                            Direction.Up => -90,
                            Direction.Down => 90,
                            Direction.Left => 180,
                            Direction.Right => 0,
                            _ => 0
                        };
                        var adjustedAngle = angle + 90; // rotate head image 90¬∞ to the right
                        var cx = head.X + 0.5;
                        var cy = head.Y + 0.5;

                        <image x="@(head.X - 0.5)" y="@(head.Y - 0.5)" width="2.0" height="2.0" href="/images/image.png" preserveAspectRatio="xMidYMid meet" class="snake-head-image" transform="rotate(@adjustedAngle @cx @cy)" />
                    }
                </svg>
                
                <!-- Message Game Over (overlay) -->
                @if (gameState.Status == GameStatus.GameOver || gameState.Status == GameStatus.Victory)
                {
                    var messageText = gameState.Status == GameStatus.Victory ? "üéâ VICTOIRE!" : "üíÄ GAME OVER!";
                    <div class="game-overlay">
                        <div class="game-message">@messageText</div>
                    </div>
                }
            </div>
        }
    </div>

    <div class="game-instructions">
        <h3>Commandes</h3>
        <ul>
            <li><kbd>‚Üë</kbd> ou <kbd>W</kbd> - Aller vers le haut</li>
            <li><kbd>‚Üì</kbd> ou <kbd>S</kbd> - Aller vers le bas</li>
            <li><kbd>‚Üê</kbd> ou <kbd>A</kbd> - Aller √† gauche</li>
            <li><kbd>‚Üí</kbd> ou <kbd>D</kbd> - Aller √† droite</li>
            <li><kbd>SPACE</kbd> - Pause/Reprendre</li>
        </ul>
    </div>

    @if (lastEvents.Count > 0)
    {
        <div class="game-events">
            <h3>Derniers √©v√©nements</h3>
            <ul>
                @foreach (var evt in lastEvents.TakeLast(5))
                {
                    <li>@evt.Message</li>
                }
            </ul>
        </div>
    }
</div>

@code {
    private GameState? gameState;
    private List<SnakeGameEvent> lastEvents = [];
    private ElementReference gameboardRef;
    private ElementReference containerRef;
    private System.Timers.Timer? gameUpdateTimer;
    private const int UpdateIntervalMs = 16; // ~60 FPS
    private DotNetObjectReference<Snake>? objRef;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        GameEngine.Initialize(GameDifficulty.Medium);
        gameState = GameEngine.GetCurrentState();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            try
            {
                await JS.InvokeVoidAsync("SnakeGame.InitializeKeyboardListener", objRef);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing keyboard listener: {ex.Message}");
            }
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    [JSInvokable]
    public void HandleArrowUp()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.SetNextDirection(Direction.Up);
        }
    }

    [JSInvokable]
    public void HandleArrowDown()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.SetNextDirection(Direction.Down);
        }
    }

    [JSInvokable]
    public void HandleArrowLeft()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.SetNextDirection(Direction.Left);
        }
    }

    [JSInvokable]
    public void HandleArrowRight()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.SetNextDirection(Direction.Right);
        }
    }

    [JSInvokable]
    public void HandleW()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.SetNextDirection(Direction.Up);
        }
    }

    [JSInvokable]
    public void HandleS()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.SetNextDirection(Direction.Down);
        }
    }

    [JSInvokable]
    public void HandleA()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.SetNextDirection(Direction.Left);
        }
    }

    [JSInvokable]
    public void HandleD()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.SetNextDirection(Direction.Right);
        }
    }

    [JSInvokable]
    public void HandleEnter()
    {
        if (gameState?.Status == GameStatus.NotStarted)
        {
            StartGame();
        }
        else if (gameState?.Status == GameStatus.GameOver || gameState?.Status == GameStatus.Victory)
        {
            ResetGame();
        }
    }

    [JSInvokable]
    public void HandleSpace()
    {
        PauseResumeGame();
    }

    private void StartGame()
    {
        GameEngine.Start();
        gameState = GameEngine.GetCurrentState();
        StartGameLoop();
    }

    private void PauseResumeGame()
    {
        if (gameState?.Status == GameStatus.Playing)
        {
            GameEngine.Pause();
        }
        else if (gameState?.Status == GameStatus.Paused)
        {
            GameEngine.Resume();
        }
        gameState = GameEngine.GetCurrentState();
        StateHasChanged();
    }

    private void ResetGame()
    {
        gameUpdateTimer?.Stop();
        GameEngine.Reset();
        gameState = GameEngine.GetCurrentState();
        lastEvents.Clear();
        StateHasChanged();
    }

    private void ChangeDifficulty(ChangeEventArgs e)
    {
        if (Enum.TryParse<GameDifficulty>(e.Value?.ToString(), out var difficulty))
        {
            GameEngine.Initialize(difficulty);
            gameState = GameEngine.GetCurrentState();
        }
    }

    private void StartGameLoop()
    {
        gameUpdateTimer = new System.Timers.Timer(UpdateIntervalMs);
        gameUpdateTimer.Elapsed += async (s, e) =>
        {
            GameEngine.Update();
            gameState = GameEngine.GetCurrentState();
            lastEvents = GameEngine.GetEventsSinceLastUpdate();

            await InvokeAsync(StateHasChanged);

            if (gameState.Status != GameStatus.Playing)
            {
                gameUpdateTimer?.Stop();
            }
        };
        gameUpdateTimer.Start();
    }

    private string FormatTime(long ms)
    {
        var totalSeconds = ms / 1000;
        var minutes = totalSeconds / 60;
        var seconds = totalSeconds % 60;
        return $"{minutes:D2}:{seconds:D2}";
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (gameUpdateTimer != null)
        {
            gameUpdateTimer.Stop();
            gameUpdateTimer.Dispose();
        }
        objRef?.Dispose();
        await Task.CompletedTask;
    }
}
