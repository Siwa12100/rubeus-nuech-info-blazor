kind: pipeline
type: docker
name: build-and-deploy-rubeus-nuech-info

trigger:
  branch:
    - main
  event:
    - push

steps:
  - name: "ğŸ” verification"
    image: mcr.microsoft.com/dotnet/sdk:9.0
    commands:
      - echo "ğŸ” [INFO] Restauration et build du projet .NET..."
      - dotnet restore NuitInfo.Rubeus.csproj || { echo "âŒ [ERROR] Restauration Ã©chouÃ©e."; exit 1; }
      - dotnet build NuitInfo.Rubeus.csproj -c Release || { echo "âŒ [ERROR] Build Ã©chouÃ©."; exit 1; }
      - echo "âœ… [SUCCESS] Build rÃ©ussi."

  - name: "ğŸ“¦ tests"
    depends_on:
      - "ğŸ” verification"
    image: mcr.microsoft.com/dotnet/sdk:9.0
    environment:
      AUTH_STRING_POSTGREE: "Host=ecirada.valorium-mc.fr;Port=5432;Database=test;Username=test;Password=nostrecossesenpresonalucarandefuocsaldintredelasrasons"
      AUTH_STRING_MONGO: "mongodb://test:nostrecossesenpresonalucarandefuocsaldintredelasrasons@ecirada.valorium-mc.fr:27018/test"
      PORT_PUBLIQUE: "5010"
    commands:
      - echo "ğŸ§ª [INFO] ExÃ©cution des tests unitaires..."
      - dotnet test Tests/NuitInfo.Rubeus.Tests.csproj -c Release --logger:"trx" || { echo "âŒ [ERROR] Tests Ã©chouÃ©s !"; exit 1; }
      - echo "âœ… [SUCCESS] Tests rÃ©ussis."

  - name: "ğŸ³ build-and-push"
    depends_on:
      - "ğŸ“¦ tests"
    image: plugins/docker
    settings:
      registry: registry.davalada.valorium-mc.fr
      repo: registry.davalada.valorium-mc.fr/rubeus-nuech-info-blazor
      username:
        from_secret: DOCKER_USERNAME
      password:
        from_secret: DOCKER_PASSWORD
      no_cache: true
      tags:
        - latest
      dockerfile: Dockerfile

  - name: "ğŸš€ deploy-vps"
    image: appleboy/drone-ssh
    depends_on:
      - "ğŸ³ build-and-push"
    settings:
      host: ecirada.valorium-mc.fr
      port: 22
      username:
        from_secret: SSH_USER
      ssh_key:
        from_secret: SSH_PRIVATE_KEY
      script:
        - echo "ğŸš€ [INFO] DÃ©ploiement de Rubeus NuitInfo Blazor..."
        - cd deploiements/rubeus-nuech-info/
        - docker compose down
        - docker compose pull
        - docker compose up -d
        - sleep 5
        - docker ps | grep rubeus-nuech-info || { echo "âŒ [ERROR] Service non lancÃ© !"; exit 1; }
        - echo "âœ… [SUCCESS] DÃ©ploiement terminÃ©."
