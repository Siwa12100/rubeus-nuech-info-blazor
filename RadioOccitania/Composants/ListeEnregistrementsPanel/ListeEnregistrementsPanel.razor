@using NuitInfo.Rubeus.RadioOccitania.Modeles
@namespace NuitInfo.Rubeus.RadioOccitania.Components.ListeEnregistrementsPanel

<div class="liste-enregistrements">
    <div class="liste-header">
        <div class="header-left">
            <h3 class="liste-title">
                <span class="liste-icon">üìª</span>
                Enregistraments √Äudio
            </h3>
            <span class="enregistrements-count">
                @(Enregistrements?.Count() ?? 0) enregistrament@(Enregistrements?.Count() > 1 ? "s" : "")
            </span>
        </div>

        <div class="header-controls">
            @* Badge d'√©tat *@
            <div class="etat-badge @(EstEnregistrementEnCours ? "actif" : "inactif")">
                <span class="etat-indicator"></span>
                <span class="etat-text">
                    @if (EstEnregistrementEnCours)
                    {
                        <text>üî¥ Enregistrament en cors</text>
                    }
                    else
                    {
                        <text>‚ö™ Pr√®st a enregistrar</text>
                    }
                </span>
            </div>

            @* Boutons de contr√¥le *@
            <div class="control-buttons">
                @if (!EstEnregistrementEnCours)
                {
                    <button class="btn btn-start" @onclick="DemarrerAsync">
                        <span class="btn-icon">‚ñ∂Ô∏è</span>
                        Comen√ßar
                    </button>
                }
                else
                {
                    <button class="btn btn-stop" @onclick="ArreterAsync">
                        <span class="btn-icon">‚èπÔ∏è</span>
                        Arrestar
                    </button>
                }

                <button class="btn btn-refresh" @onclick="RafraichirAsync" disabled="@EstEnregistrementEnCours">
                    <span class="btn-icon">üîÑ</span>
                    Actualizar
                </button>
            </div>
        </div>
    </div>

    <div class="liste-body">
        @if (Enregistrements != null && Enregistrements.Any())
        {
            <div class="enregistrements-grid">
                @foreach (var enregistrement in Enregistrements.OrderByDescending(e => e.DateCreation))
                {
                    <div class="enregistrement-card">
                        <div class="card-header-row">
                            <div class="card-title-group">
                                <h4 class="card-title">@enregistrement.NomFichier</h4>
                                <span class="card-date">@enregistrement.DateCreation.ToString("dd/MM/yyyy HH:mm:ss")</span>
                            </div>

                            @* Badge de statut IA *@
                            <div class="statut-ia-badge statut-@ObtenirStatutGlobal(enregistrement).ToString().ToLower()">
                                @ObtenirIconeStatut(enregistrement)
                                @ObtenirLibelleStatut(enregistrement)
                            </div>
                        </div>

                        <div class="card-metadata">
                            <div class="metadata-item">
                                <span class="metadata-icon">‚è±Ô∏è</span>
                                <span class="metadata-label">Durada:</span>
                                <span class="metadata-value">
                                    @FormaterseDuree(enregistrement.Duree)
                                </span>
                            </div>

                            <div class="metadata-item">
                                <span class="metadata-icon">üíæ</span>
                                <span class="metadata-label">Talha:</span>
                                <span class="metadata-value">@enregistrement.TailleFormatee</span>
                            </div>

                            <div class="metadata-item">
                                <span class="metadata-icon">üìÖ</span>
                                <span class="metadata-label">Expiracion:</span>
                                <span class="metadata-value @(enregistrement.EstExpire ? "expire" : "")">
                                    @if (enregistrement.EstExpire)
                                    {
                                        <text>‚ö†Ô∏è Expirat</text>
                                    }
                                    else if (enregistrement.JoursAvantExpiration <= 7)
                                    {
                                        <text>üî∂ @enregistrement.JoursAvantExpiration jorn@(enregistrement.JoursAvantExpiration > 1 ? "s" : "")</text>
                                    }
                                    else
                                    {
                                        <text>‚úÖ @enregistrement.JoursAvantExpiration jorns</text>
                                    }
                                </span>
                            </div>

                            <div class="metadata-item">
                                <span class="metadata-icon">üìÇ</span>
                                <span class="metadata-label">Fichi√®r:</span>
                                <span class="metadata-value">
                                    @if (enregistrement.FichierExiste)
                                    {
                                        <text>‚úÖ Disponible</text>
                                    }
                                    else
                                    {
                                        <text>‚ùå Mancant</text>
                                    }
                                </span>
                            </div>
                        </div>

                        @* Actions IA *@
                        <div class="card-actions">
                            @* Transcription *@
                            <button class="btn-action btn-transcription"
                                    @onclick="() => DemanderTranscriptionAsync(enregistrement)"
                                    disabled="@(enregistrement.StatutTranscription == StatutTraitementIA.EnCours || !enregistrement.FichierExiste)">
                                <span class="action-icon">üìù</span>
                                <span class="action-text">
                                    @switch (enregistrement.StatutTranscription)
                                    {
                                        case StatutTraitementIA.NonDemarre:
                                            <text>Transcrire</text>
                                            break;
                                        case StatutTraitementIA.EnCours:
                                            <text>Transcripcion...</text>
                                            break;
                                        case StatutTraitementIA.Termine:
                                            <text>‚úÖ Transcrit</text>
                                            break;
                                        case StatutTraitementIA.Erreur:
                                            <text>‚ùå Error</text>
                                            break;
                                        default:
                                            <text>Transcrire</text>
                                            break;
                                    }
                                </span>
                            </button>

                            @* Synth√®se *@
                            <button class="btn-action btn-synthese"
                                    @onclick="() => DemanderSyntheseAsync(enregistrement)"
                                    disabled="@(enregistrement.StatutSynthese == StatutTraitementIA.EnCours || 
                                               enregistrement.StatutTranscription != StatutTraitementIA.Termine)">
                                <span class="action-icon">ü§ñ</span>
                                <span class="action-text">
                                    @switch (enregistrement.StatutSynthese)
                                    {
                                        case StatutTraitementIA.NonDemarre:
                                            <text>Sintetizar</text>
                                            break;
                                        case StatutTraitementIA.EnCours:
                                            <text>Sint√®si...</text>
                                            break;
                                        case StatutTraitementIA.Termine:
                                            <text>‚úÖ Sintetizat</text>
                                            break;
                                        case StatutTraitementIA.Erreur:
                                            <text>‚ùå Error</text>
                                            break;
                                        default:
                                            <text>Sintetizar</text>
                                            break;
                                    }
                                </span>
                            </button>
                        </div>

                        @* Affichage conditionnel des r√©sultats *@
                        @if (!string.IsNullOrWhiteSpace(enregistrement.CheminTranscription) && 
                             enregistrement.StatutTranscription == StatutTraitementIA.Termine)
                        {
                            <div class="card-result result-transcription">
                                <div class="result-header">
                                    <span class="result-icon">üìù</span>
                                    <span class="result-title">Transcripcion disponibla</span>
                                </div>
                                <div class="result-actions">
                                    <a href="@enregistrement.CheminTranscription" 
                                       class="result-link" 
                                       target="_blank">
                                        Veire lo fichi√®r
                                    </a>
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(enregistrement.ResumeTexte) && 
                             enregistrement.StatutSynthese == StatutTraitementIA.Termine)
                        {
                            <div class="card-result result-synthese">
                                <div class="result-header">
                                    <span class="result-icon">ü§ñ</span>
                                    <span class="result-title">Resumit IA</span>
                                </div>
                                <div class="result-content">
                                    <p class="result-text">@enregistrement.ResumeTexte</p>
                                </div>
                                @if (!string.IsNullOrWhiteSpace(enregistrement.CheminSynthese))
                                {
                                    <div class="result-actions">
                                        <a href="@enregistrement.CheminSynthese" 
                                           class="result-link" 
                                           target="_blank">
                                            Veire lo fichi√®r complet
                                        </a>
                                    </div>
                                }
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(enregistrement.MessageErreur))
                        {
                            <div class="card-result result-error">
                                <div class="result-header">
                                    <span class="result-icon">‚ö†Ô∏è</span>
                                    <span class="result-title">Error de tractament</span>
                                </div>
                                <div class="result-content">
                                    <p class="result-text error-message">@enregistrement.MessageErreur</p>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">üéôÔ∏è</div>
                <h4 class="empty-title">Cap d'enregistrament</h4>
                <p class="empty-text">
                    Clicatz sus ¬´ Comen√ßar ¬ª per lan√ßar lo primi√®r enregistrament.
                </p>
            </div>
        }
    </div>
</div>
